<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction • bendr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bendr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction.html">Introduction</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/apeterson91/rndpp">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Introduction</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/apeterson91/rndpp/blob/master/vignettes/Introduction.Rmd"><code>vignettes/Introduction.Rmd</code></a></small>
      <div class="hidden name"><code>Introduction.Rmd</code></div>

    </div>

    
    
<div id="nested-dirichlet-process-for-inhomogenous-poisson-processes" class="section level1">
<h1 class="hasAnchor">
<a href="#nested-dirichlet-process-for-inhomogenous-poisson-processes" class="anchor"></a>Nested Dirichlet Process for Inhomogenous Poisson Processes</h1>
<p>This vignette serves to introduce the <code>bendr</code> R package. <code>bendr</code> is an R package that fits the Nested Dirichlet Process to Built Environment data, modeled as realizations of an Inhomogenous Poisson Process. We begin with substantive motivation and theoretical notation to elucidate some key model components. The data that we generate below is available in the package as <code>school_data</code>.</p>
<div id="motivation-and-notation" class="section level2">
<h2 class="hasAnchor">
<a href="#motivation-and-notation" class="anchor"></a>Motivation and Notation</h2>
<p>The motivation for this model comes from a scientific interest in classifying food environments around school or residential environments. If we pick, say, Fast Food Restaurants (FFRs), we could model the rate at which these restaurants occur around schools by modeling their distances from schools as an inhomogenous poisson process.</p>
<p>Denote <span class="math inline">\(r_{ij}\)</span> as the distance between the <span class="math inline">\(i\)</span>th FFR and <span class="math inline">\(j\)</span>th school, where all <span class="math inline">\(r_{ij} &lt;R\)</span>. This <span class="math inline">\(R\)</span> is something like a 1 or 2 mile radius chosen based on data available at hand and the scientific question of interest. If we model these distances as realizations from an inhomogenous poisson process, then the likelihood will decompoase as follows:</p>
<p><span class="math display">\[
p(\{r_{ij}\}|\gamma,f_j(\cdot)) \propto \prod_{j=1}^{J}\gamma_j^{n_j}\exp\{-\gamma_j\}\prod_{i=1}^{n_j}f_j(r_{ij})
\]</span> In the above, <span class="math inline">\(f_j(\cdot)\)</span> is the spatial FFR incidence density (normalized intensity function) of the <span class="math inline">\(j\)</span>th school, <span class="math inline">\(\gamma_j\)</span> is the expected number of FFRs within radius <span class="math inline">\(R\)</span> and <span class="math inline">\(n_j\)</span> is the number of FFRs observed around the <span class="math inline">\(j\)</span>th school within the <span class="math inline">\(R\)</span> distance boundary.</p>
<p>Since the <span class="math inline">\(\gamma_j\)</span> and the <span class="math inline">\(f_j\)</span> are multiplied together, they’re independent and can be modeled separately. The <code>rndpp</code> package offers solutions for both, but the modeling of <span class="math inline">\(\gamma_j\)</span> in <code>rndpp</code> is akin to a generalized linear model with a gamma distribution and log link function : <span class="math inline">\(\gamma_j = \exp(x_j^{T}\beta)\)</span>. Since this kind of model is fairly common, we won’t spend much time writing about it here, beyond showing what function call you can use to estimate the coefficients, <span class="math inline">\(\beta\)</span> in <code>rndpp</code>.</p>
<p>In contrast, modeling the <span class="math inline">\(f_j(\cdot)\)</span> will be our main focus, as it offers us a lot more opportunities to investigate how the rate of FFRs around schools change as a function of distance. Let’s start loading in some libraries and simulating some data before elaborating further.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(bendr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyr)</a></code></pre></div>
</div>
<div id="simulation-set-up" class="section level2">
<h2 class="hasAnchor">
<a href="#simulation-set-up" class="anchor"></a>Simulation Set-up</h2>
<p>We’ll simulate distances from the following 3 intensity functions, each composed themselves of a <em>mixture</em> of simpler densities: <span class="math display">\[
f_1(d) = \frac{1}{2}\text{beta}(d|1,8) + \frac{1}{2}\text{beta}(d|6,1), \\
f_2(d) = \frac{1}{5}\text{beta}(d|3,2) + \frac{2}{3}\text{beta}(d|3,1) + \frac{2}{15}\text{beta}(d|1,1)\\
f_3(d) = \frac{1}{2}\text{beta}(d|8,2) + \frac{1}{2}\text{dbeta}(d,30,50).
\]</span> We’ll plot these below, choosing a 5 mile distance boundary, but any boundary could be used in principal.</p>
<p><img src="Introduction_files/figure-html/intensity_plots-1.png" width="700"></p>
<p>Each intensity function corresponds to a different kind of FFR exposure around schools. Schools around the first intensity function will have a lot of FFRs within the first mile or so from their school, but then not many until getting about 4 or more miles from school. Similarly, school’s that have FFRs simulated from cluster 3 will have a lot of FFrs at around 2 miles away from them, but almost none within 1 mile.</p>
<p>These different kinds of patterns may be of scientific interest because they could help explain why certain kids are more likely to go to FFRs and others aren’t.</p>
<p>Let’s assume a constant <span class="math inline">\(\gamma\)</span> across all the schools, simulating 50 schools from each intensity function.<br><img src="Introduction_files/figure-html/density_estimates-1.png" width="700"></p>
<p>We can see that the empirical estimates (when we know which cluster each school belongs to), correspond well to the real densities. Now how are we going to model these densities and cluster each school to it’s appropriate cluster?</p>
</div>
<div id="the-nested-dirichlet-process" class="section level2">
<h2 class="hasAnchor">
<a href="#the-nested-dirichlet-process" class="anchor"></a>The Nested Dirichlet Process</h2>
<p>The Nested Dirichlet Process (NDP) is an extension of the Dirichlet Process, that uses a Dirichlet Process as the base measure for another Dirichlet Process - hence the nested name. The mathematic formulation is abstract, but can be seen below. If you don’t have familiarity with the Dirichlet Process or Random Measures (especially random stick-breaking measures), the <span class="math inline">\(\delta(\cdot)\)</span> function is a point mass indicator that that only exists at the subscript value and the <span class="math inline">\(*\)</span> on the <span class="math inline">\(\pi_k^*\)</span> and other values reflects the idea that there may be multiple duplicate <span class="math inline">\(\pi_k\)</span>’s and the <span class="math inline">\(\pi_k^*\)</span> are the unique values. For further reading see Chapter 23 of Bayesian Data Analysis (3rd edition), for now let’s see the math:</p>
<p><span class="math display">\[
G_j \sim Q = DP(\alpha,DP(\rho,G_0))\\
Q = \sum_{k=1}^{\infty} \pi^*_k\delta_{G^*_j(\cdot)}(\cdot) \\
G_j = \sum_{l=1}^{\infty} w^*_{lk}\delta_{\theta_{lk}^*}(\cdot) 
\]</span></p>
<p>Essentially we’re going to use the Nested Dirichlet process to draw several different <em>clusters</em> of mixing measures to combine several simpler densities (like the Normal) that will ultimately be used to estimate the inhomogenous poisson process intensity function.</p>
<p>The math is below. For computational purposes we’re going to use a Normal mixing kernel and truncate the infinite mixture above with some finite number of components <span class="math inline">\(K\)</span> and <span class="math inline">\(L\)</span>, for the two different indices, respectively. If we wanted to use a different mixing measure, the <code>rndpp</code> package also offers the use of a Beta mixing measure with either a global or cluster specific variance parameter. Much of the code we’re using here will be the same, but you can see <code><a href="https://rdrr.io/pkg/rndpp/man/beta_nd_nhpp.html">rndpp::beta_nd_nhpp</a></code> for more information.</p>
<p><span class="math display">\[
f_j(r) = \int \mathcal{N}(r|\mu,\sigma^2)dG_j((\mu,\sigma^2))\\
G_j \sim Q = \sum_{k=1}^{K} \pi_k^*\delta_{G^*_j(\cdot)}(\cdot)\\
G_j = \sum_{l=1}^{L} w_{lk}^*\delta_{(\mu,\sigma^2)^*}(\cdot)
\]</span></p>
<p>We can use a smaller number of <span class="math inline">\(L\)</span> and <span class="math inline">\(K\)</span> stick components for computational convenience and since we know the true number of clusters - in a real data analysis you would want to use more. We’ll set <span class="math inline">\(\alpha=\rho=1\)</span> to encourage a small number of clusters, set non-informative conjugate priors and fit the model as follows.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/nd_nhpp_fixed.html">nd_nhpp_fixed</a></span>(<span class="dt">distances_col =</span> <span class="st">"distances"</span>,</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">                     <span class="dt">id_col =</span> <span class="st">"school_id"</span>,</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">                     <span class="dt">data =</span> school_data,</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">                     <span class="dt">L =</span> <span class="dv">5</span>, <span class="dt">K =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">                     <span class="dt">alpha =</span> <span class="dv">1</span>, <span class="dt">rho =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">                     <span class="dt">mu_0 =</span> <span class="dv">0</span>, <span class="dt">kappa_0 =</span> <span class="dv">1</span>, <span class="co">## Normal Mean Base Measure Hyperparameters</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">                     <span class="dt">sigma_0 =</span> <span class="dv">1</span>, <span class="dt">nu_0 =</span> <span class="dv">1</span>, <span class="co">## Inverse Chi square prior Hyperparameters</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">                     <span class="dt">iter_max =</span> <span class="fl">1.5E5</span>L, <span class="co">## To get good resolution, could possibly use more or less depending on convergence</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">                     <span class="dt">warm_up =</span> <span class="fl">1.4E5</span>L,</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">                     <span class="dt">thin =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">                     <span class="dt">seed =</span> <span class="dv">34143</span>)</a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co">#&gt; Beginning Sampling</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="co">#&gt; ----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="co">#&gt; [Chain 1] Beginning of iteration: 1 / 150000 (0%)     [Warmup]</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="co">#&gt; [Chain 1] Beginning of iteration: 15000 / 150000 (10%)    [Warmup]</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="co">#&gt; [Chain 1] Beginning of iteration: 30000 / 150000 (20%)    [Warmup]</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co">#&gt; [Chain 1] Beginning of iteration: 45000 / 150000 (30%)    [Warmup]</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="co">#&gt; [Chain 1] Beginning of iteration: 60000 / 150000 (40%)    [Warmup]</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co">#&gt; [Chain 1] Beginning of iteration: 75000 / 150000 (50%)    [Warmup]</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="co">#&gt; [Chain 1] Beginning of iteration: 90000 / 150000 (60%)    [Warmup]</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="co">#&gt; [Chain 1] Beginning of iteration: 105000 / 150000 (70%)   [Warmup]</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"><span class="co">#&gt; [Chain 1] Beginning of iteration: 120000 / 150000 (80%)   [Warmup]</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="co">#&gt; [Chain 1] Beginning of iteration: 135000 / 150000 (90%)   [Warmup]</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"><span class="co">#&gt; [Chain 1] Beginning of iteration: 140001 / 150000 (93%)   [Sampling]</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25"><span class="co">#&gt; [Chain 1] Beginning of iteration: 150000 / 150000 (100%)  [Sampling]</span></a></code></pre></div>
<p>The ndp model object returned by <code>nd_nhpp</code> contains the parameters of interest as <code><a href="https://rdrr.io/pkg/coda/man/mcmc.html">coda::mcmc</a></code> objects, so that the coda functions can be called on them easily. For example, we can look at the <span class="math inline">\(\pi_k\)</span> parameters that denote the probability of a school being assigned to the <span class="math inline">\(k\)</span>th cluster.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(fit<span class="op">$</span>pi)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#&gt; Iterations = 1:10000</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; Thinning interval = 1 </span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt; Number of chains = 1 </span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; Sample size per chain = 10000 </span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt; 1. Empirical mean and standard deviation for each variable,</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt;    plus standard error of the mean:</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">#&gt;            Mean      SD  Naive SE Time-series SE</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt; pi k: 1 0.35825 0.04809 0.0004809      0.0008428</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#&gt; pi k: 2 0.32957 0.07404 0.0007404      0.0117443</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="co">#&gt; pi k: 3 0.25108 0.10335 0.0010335      0.0193425</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">#&gt; pi k: 4 0.03487 0.06916 0.0006916      0.0108821</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co">#&gt; pi k: 5 0.02623 0.05358 0.0005358      0.0079547</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="co">#&gt; 2. Quantiles for each variable:</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="co">#&gt;              2.5%      25%      50%     75%  97.5%</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="co">#&gt; pi k: 1 2.669e-01 0.325638 0.357296 0.39006 0.4559</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="co">#&gt; pi k: 2 1.361e-01 0.301660 0.342776 0.37597 0.4355</span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="co">#&gt; pi k: 3 5.249e-03 0.215624 0.267112 0.31572 0.4151</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="co">#&gt; pi k: 4 8.219e-05 0.001783 0.006557 0.02430 0.2612</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="co">#&gt; pi k: 5 7.817e-05 0.001826 0.006722 0.02373 0.2330</span></a></code></pre></div>
<p>We can also call <code>rndpp</code> specific functions that will help us check whether our model is correctly estimating the densities. To begin with, we can look at an estimate of the global density estimate (averaging over all clusters’ densities):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="../reference/plot_global_density.html">plot_global_density</a></span>(fit,<span class="dt">r =</span> school_data<span class="op">$</span>distances)</a></code></pre></div>
<p><img src="Introduction_files/figure-html/plot_global-1.png" width="700"> The above plot looks similar to the empirical estimate. This is a good sign! While the height might not be the same, we have to remember that since we’re using a normal mixing measure, we’re likely to see less accuracy in the density estimation near the boundaries. This might be a good reason to try the beta mixing measure instead, though it should be noted that since the beta mixing measure is not conjugate, its sampling is typically less efficient.</p>
<p>Let’s now see what our estimates of the different plots look like. As you can see from the summary of the pi’s there are nonzero means for all five probabilities, but the medians of the 4th and 5th cluster are pretty small. We only want to look at the clusters that have a meaningful <span class="math inline">\(\pi_k\)</span>. We can use the <code>plot_cluster_densities</code>, which has the argument <code>pi_threshold</code> to allow users to only look at clusters with a certain probability of assignment. The default is 0.1, which should be sufficient in this case.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="../reference/plot_cluster_densities.html">plot_cluster_densities</a></span>(fit,<span class="dt">switch =</span> <span class="st">'color'</span>)</a></code></pre></div>
<p><img src="Introduction_files/figure-html/plot_cluster-1.png" width="700"> This looks good! Both the u shaped intensity functions are well defined and we can tell that even though the monotonicaly increasing intensity function has a decay at the end of the bounary, likely because of the edge effect, the model is still able to capture the general pattern.</p>
<p>It is important to note that since we transformed the distances, the previous plot of the densities does not show the “true” densities, but only densities that are proportional on the domain. The true densities can be plotted using the <code>plot_cluster_densities</code> function with the arguments <code>transform = TRUE</code> as listed below.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="../reference/plot_cluster_densities.html">plot_cluster_densities</a></span>(fit,<span class="dt">switch=</span><span class="st">'facet'</span>,<span class="dt">transform =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="Introduction_files/figure-html/plot_cluster_fac-1.png" width="700"></p>
<p>In order to determine how well the model is able to discriminate between the differing clusters, we can plot the pairwise probability of each school being assigned to the same cluster as another school. Since we simulated fifty schools from each intensity function we would expect to see fifty by fifty blocks of high probability along the diagnoal.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="../reference/plot_pairs.html">plot_pairs</a></span>(fit,<span class="dt">sort =</span> F)</a></code></pre></div>
<p><img src="Introduction_files/figure-html/plot_unsorted_pairs-1.png" width="700"></p>
<p>Looking at the plot, we can see that the model is able to discriminate between the differing intensity functiosn fairly well, though it has a hard time discriminating between the second and third cluster. We can also sort the pairwise probability plot to try and identify groups - since in real world data we won’t know where the “true clusters” really are.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="../reference/plot_pairs.html">plot_pairs</a></span>(fit,<span class="dt">sort =</span> T)</a></code></pre></div>
<p><img src="Introduction_files/figure-html/plot_sorted_pairs-1.png" width="700"></p>
<p>Turning our attention now to estimationg of <span class="math inline">\(\gamma_j\)</span>, the mean number of FFRs, we can easily fit this model via the <code>nhpp_hmc</code> function. As said, this isn’t anything particularly novel, so we provide the syntax below for a simple intercept model, but a more complicated regression could be fit as well.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">df &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">y=</span>school_data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(school_id) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/tally.html">count</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(n))</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">reg_fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/nhpp_hmc.html">nhpp_hmc</a></span>(y<span class="op">~</span><span class="dv">1</span>,<span class="dt">data=</span>df,<span class="dt">iter_max=</span><span class="fl">2E3</span>,<span class="dt">warm_up =</span> <span class="fl">1E3</span>)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#&gt; [Chain 1] Beginning of iteration: 1 / 2000 (0%)   [Warmup]</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">#&gt; [Chain 1] Beginning of iteration: 200 / 2000 (10%)    [Warmup]</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#&gt; [Chain 1] Beginning of iteration: 400 / 2000 (20%)    [Warmup]</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt; [Chain 1] Beginning of iteration: 600 / 2000 (30%)    [Warmup]</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#&gt; [Chain 1] Beginning of iteration: 800 / 2000 (40%)    [Warmup]</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="co">#&gt; [Chain 1] Beginning of iteration: 1000 / 2000 (50%)   [Warmup]</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co">#&gt; [Chain 1] Beginning of iteration: 1001 / 2000 (50%)   [Sampling]</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">#&gt; [Chain 1] Beginning of iteration: 1200 / 2000 (60%)   [Sampling]</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co">#&gt; [Chain 1] Beginning of iteration: 1400 / 2000 (70%)   [Sampling]</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co">#&gt; [Chain 1] Beginning of iteration: 1600 / 2000 (80%)   [Sampling]</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="co">#&gt; [Chain 1] Beginning of iteration: 1800 / 2000 (90%)   [Sampling]</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="co">#&gt; [Chain 1] Beginning of iteration: 2000 / 2000 (100%)  [Sampling]</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15">reg_fit</a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="co">#&gt;  groups:</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18"><span class="co">#&gt; ------</span></a>
<a class="sourceLine" id="cb9-19" data-line-number="19"><span class="co">#&gt; Regression Statistics</span></a>
<a class="sourceLine" id="cb9-20" data-line-number="20"><span class="co">#&gt; ------</span></a>
<a class="sourceLine" id="cb9-21" data-line-number="21"><span class="co">#&gt;             Median SD  </span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22"><span class="co">#&gt; (Intercept) 2.28   0.03</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23"><span class="co">#&gt; --- </span></a>
<a class="sourceLine" id="cb9-24" data-line-number="24"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb9-25" data-line-number="25"><span class="co">#&gt; Sample avg. posterior predictive distribution of y:</span></a>
<a class="sourceLine" id="cb9-26" data-line-number="26"><span class="co">#&gt;          Median SD  </span></a>
<a class="sourceLine" id="cb9-27" data-line-number="27"><span class="co">#&gt; mean_PPD 9.82   0.28</span></a>
<a class="sourceLine" id="cb9-28" data-line-number="28"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb9-29" data-line-number="29"><span class="co">#&gt; ------</span></a></code></pre></div>
<p>To provide a point of reference, this model can be replicated in standard libraries, e.g. <code><a href="https://rdrr.io/r/stats/glm.html">stats::glm</a></code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">reg_fit2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(y<span class="op">~</span><span class="dv">1</span>,<span class="dt">data=</span>df,<span class="dt">family=</span><span class="kw"><a href="https://rdrr.io/r/stats/family.html">Gamma</a></span>(<span class="dt">link=</span><span class="st">'log'</span>))</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">reg_fit2</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">#&gt; Call:  glm(formula = y ~ 1, family = Gamma(link = "log"), data = df)</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="co">#&gt; (Intercept)  </span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="co">#&gt;       2.286  </span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co">#&gt; Degrees of Freedom: 149 Total (i.e. Null);  149 Residual</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co">#&gt; Null Deviance:       15.6 </span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co">#&gt; Residual Deviance: 15.6  AIC: 763.1</span></a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#nested-dirichlet-process-for-inhomogenous-poisson-processes">Nested Dirichlet Process for Inhomogenous Poisson Processes</a><ul class="nav nav-pills nav-stacked">
<li><a href="#motivation-and-notation">Motivation and Notation</a></li>
      <li><a href="#simulation-set-up">Simulation Set-up</a></li>
      <li><a href="#the-nested-dirichlet-process">The Nested Dirichlet Process</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Adam Peterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
